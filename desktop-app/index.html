<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Orbitor - Multi-Platform Sync</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container { padding: 15px; max-width: 520px; margin: 0 auto; }
    
    .header {
      text-align: center;
      padding: 15px 0;
      color: white;
    }
    .header h1 { font-size: 22px; margin-bottom: 3px; }
    .header p { opacity: 0.9; font-size: 13px; }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      font-size: 14px;
      margin-bottom: 12px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #555;
    }
    .form-group input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    .form-group small {
      display: block;
      margin-top: 3px;
      font-size: 10px;
      color: #888;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
    }
    .btn-primary:hover { transform: translateY(-1px); }
    .btn-sm { padding: 6px 12px; font-size: 11px; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-danger { background: #ff4757; color: white; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .platform-card {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .platform-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .platform-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
    }
    .platform-status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
    }
    .platform-status.connected { background: #d4edda; color: #155724; }
    .platform-status.disconnected { background: #f8f9fa; color: #6c757d; }
    .platform-status.syncing { background: #cce5ff; color: #004085; }
    .platform-status.error { background: #f8d7da; color: #721c24; }
    
    .platform-fields { display: none; margin-top: 10px; }
    .platform-fields.show { display: block; }
    
    .platform-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .toggle-btn {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
    }
    
    .sync-info {
      text-align: center;
      padding: 8px;
      font-size: 11px;
      color: rgba(255,255,255,0.8);
    }
    
    .global-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .global-actions .btn { flex: 1; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’¬ Chat Orbitor Sync</h1>
      <p>Multi-Platform Message Sync</p>
    </div>
    
    <div class="card">
      <h2>ğŸ”‘ Chat Orbitor Token</h2>
      <div class="form-group">
        <input type="password" id="chatorbitor-token" placeholder="Paste your Chat Orbitor API token">
        <small>Get from Chat Orbitor â†’ Settings â†’ API Token</small>
      </div>
      <button class="btn btn-primary btn-sm" id="save-token-btn">Save Token</button>
    </div>
    
    <div class="card">
      <h2>ğŸ“± Platforms</h2>
      <div id="platforms-container"></div>
      
      <div class="global-actions">
        <button class="btn btn-primary" id="sync-all-btn">ğŸ”„ Sync All</button>
        <button class="btn btn-secondary" id="clear-all-btn">ğŸ—‘ï¸ Clear All</button>
      </div>
    </div>
    
    <div class="sync-info">
        âœ… Auto-syncs every 1 minute â€¢ Runs in background when closed<br>
        <small>ğŸ“Œ Closing this window = minimizes to system tray (keeps running)</small><br>
        <small>ğŸš€ Auto-starts when Windows boots up</small>
    </div>
  </div>
  
  <script>
    let platforms = {};
    let credentials = {};
    
    // Platform login methods
    const loginMethods = {
      whatsapp: 'qrcode', // Uses QR code scan (like actual WhatsApp Web)
      twitter: 'credentials', // Can use username/password
      linkedin: 'cookies',
      instagram: 'browser', // Can use browser login (opens Instagram)
      facebook: 'cookies'
    };
    
    // Platform cookie instructions
    const cookieInstructions = {
      twitter: {
        auth_token: 'Login to x.com â†’ F12 â†’ Application â†’ Cookies â†’ auth_token',
        ct0: 'Same location â†’ ct0'
      },
      linkedin: {
        li_at: 'Login to linkedin.com â†’ F12 â†’ Application â†’ Cookies â†’ li_at',
        JSESSIONID: 'Same location â†’ JSESSIONID (include quotes)'
      },
      instagram: {
        sessionid: 'Login to instagram.com â†’ F12 â†’ Application â†’ Cookies â†’ sessionid',
        csrftoken: 'Same location â†’ csrftoken'
      },
      facebook: {
        c_user: 'Login to facebook.com â†’ F12 â†’ Application â†’ Cookies â†’ c_user',
        xs: 'Same location â†’ xs'
      }
    };
    
    // WhatsApp state
    let whatsappState = {
      status: 'disconnected',
      qrCode: null,
      phoneNumber: null
    };
    
    // Render platforms
    function renderPlatforms() {
      const container = document.getElementById('platforms-container');
      container.innerHTML = '';
      
      for (const [id, config] of Object.entries(platforms)) {
        const platformData = credentials.platforms?.[id] || {};
        const hasCookies = platformData.cookies && Object.keys(platformData.cookies).length > 0;
        const lastSync = platformData.lastSync;
        const canLogin = loginMethods[id] === 'credentials';
        
        const card = document.createElement('div');
        card.className = 'platform-card';
        
        // WhatsApp has special QR code login
        if (id === 'whatsapp') {
          const isConnected = whatsappState.status === 'connected' || hasCookies;
          card.innerHTML = `
            <div class="platform-header">
              <div class="platform-title">
                <span>${config.icon}</span>
                <span>${config.name}</span>
              </div>
              <span class="platform-status ${isConnected ? 'connected' : 'disconnected'}" id="status-${id}">
                ${isConnected ? 'âœ“ Connected' : whatsappState.status === 'qr_ready' ? 'ğŸ“± Scan QR' : 'Not connected'}
              </span>
            </div>
            ${lastSync ? `<div style="font-size:10px;color:#888;margin-bottom:8px;">Last sync: ${new Date(lastSync).toLocaleString()}</div>` : ''}
            ${whatsappState.phoneNumber ? `<div style="font-size:11px;color:#25D366;margin-bottom:8px;">ğŸ“± ${whatsappState.phoneNumber}</div>` : ''}
            
            <div id="whatsapp-content">
              ${whatsappState.status === 'qr_ready' && whatsappState.qrCode ? `
                <div style="text-align:center;padding:15px;background:#f8f9fa;border-radius:8px;margin-bottom:12px;">
                  <div style="font-size:12px;color:#333;margin-bottom:10px;font-weight:600;">
                    ğŸ“± Scan with WhatsApp
                  </div>
                  <img src="${whatsappState.qrCode}" alt="WhatsApp QR Code" style="max-width:200px;border-radius:8px;"/>
                  <div style="font-size:10px;color:#666;margin-top:8px;">
                    Open WhatsApp â†’ Settings â†’ Linked Devices â†’ Link a Device
                  </div>
                </div>
              ` : whatsappState.status === 'connecting' ? `
                <div style="text-align:center;padding:20px;background:#f0f7ff;border-radius:8px;margin-bottom:12px;">
                  <div style="font-size:14px;color:#004085;">â³ Initializing WhatsApp...</div>
                  <div style="font-size:11px;color:#666;margin-top:5px;">This may take a moment</div>
                </div>
              ` : isConnected ? `
                <div style="text-align:center;padding:15px;background:#d4edda;border-radius:8px;margin-bottom:12px;">
                  <div style="font-size:14px;color:#155724;">âœ… WhatsApp Connected!</div>
                  <div style="font-size:11px;color:#155724;margin-top:5px;">Messages will sync automatically</div>
                </div>
              ` : `
                <div style="background:#e8f5e9;padding:12px;border-radius:8px;margin-bottom:12px;">
                  <div style="font-size:12px;color:#1b5e20;margin-bottom:8px;">
                    <strong>ğŸ’¬ Connect WhatsApp</strong>
                  </div>
                  <div style="font-size:11px;color:#555;line-height:1.5;">
                    1. Click "Connect WhatsApp" below<br>
                    2. Scan QR code with your phone<br>
                    3. Messages will sync to Chat Orbitor!
                  </div>
                </div>
              `}
            </div>
            
            <div class="platform-actions">
              ${isConnected ? `
                <button class="btn btn-secondary btn-sm" onclick="syncPlatform('whatsapp')">ğŸ”„ Sync Now</button>
                <button class="btn btn-danger btn-sm" onclick="disconnectWhatsApp()">ğŸ”Œ Disconnect</button>
              ` : `
                <button class="btn btn-primary btn-sm" onclick="connectWhatsApp()" id="whatsapp-connect-btn" style="background:#25D366;">
                  ${whatsappState.status === 'connecting' ? 'â³ Connecting...' : whatsappState.status === 'qr_ready' ? 'ğŸ”„ Refresh QR' : 'ğŸ“± Connect WhatsApp'}
                </button>
              `}
            </div>
          `;
          container.appendChild(card);
          continue;
        }
        
        // Twitter has special login option
        if (id === 'twitter') {
          card.innerHTML = `
            <div class="platform-header">
              <div class="platform-title">
                <span>${config.icon}</span>
                <span>${config.name}</span>
              </div>
              <span class="platform-status ${hasCookies ? 'connected' : 'disconnected'}" id="status-${id}">
                ${hasCookies ? 'âœ“ Connected' : 'Not connected'}
              </span>
            </div>
            ${lastSync ? `<div style="font-size:10px;color:#888;margin-bottom:8px;">Last sync: ${new Date(lastSync).toLocaleString()}</div>` : ''}
            
            <div style="display:flex;gap:8px;margin-bottom:10px;">
              <button class="toggle-btn" onclick="showTwitterLogin()" id="twitter-login-tab" style="font-weight:600;color:#667eea;">
                ğŸ” Login
              </button>
              <button class="toggle-btn" onclick="showTwitterCookies()" id="twitter-cookies-tab">
                ğŸª Cookies
              </button>
            </div>
            
            <!-- Login Form -->
            <div class="platform-fields show" id="twitter-login-form">
              <div class="form-group">
                <label>Username (without @)</label>
                <input type="text" id="twitter-username" placeholder="your_username">
              </div>
              <div class="form-group">
                <label>Password</label>
                <input type="password" id="twitter-password" placeholder="Your password">
              </div>
              <div class="form-group">
                <label>Email (optional, for verification)</label>
                <input type="email" id="twitter-email" placeholder="your@email.com">
                <small>Required if Twitter asks for email verification</small>
              </div>
              <div class="platform-actions">
                <button class="btn btn-primary btn-sm" onclick="loginTwitter()" id="twitter-login-btn">ğŸ” Login</button>
                <button class="btn btn-secondary btn-sm" onclick="syncPlatform('twitter')">ğŸ”„ Sync</button>
                <button class="btn btn-danger btn-sm" onclick="clearPlatform('twitter')">ğŸ—‘ï¸</button>
              </div>
            </div>
            
            <!-- Cookies Form (hidden by default) -->
            <div class="platform-fields" id="twitter-cookies-form">
              ${config.cookieFields.map(field => `
                <div class="form-group">
                  <label>${field}</label>
                  <input type="text" id="${id}-${field}" placeholder="${field}" value="${platformData.cookies?.[field] || ''}">
                  <small>${cookieInstructions[id]?.[field] || ''}</small>
                </div>
              `).join('')}
              <div class="platform-actions">
                <button class="btn btn-primary btn-sm" onclick="savePlatform('${id}')">ğŸ’¾ Save</button>
                <button class="btn btn-secondary btn-sm" onclick="syncPlatform('${id}')">ğŸ”„ Sync</button>
                <button class="btn btn-danger btn-sm" onclick="clearPlatform('${id}')">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        } 
        // Instagram has browser login option (like Twitter but opens Instagram website)
        else if (id === 'instagram') {
          card.innerHTML = `
            <div class="platform-header">
              <div class="platform-title">
                <span>${config.icon}</span>
                <span>${config.name}</span>
              </div>
              <span class="platform-status ${hasCookies ? 'connected' : 'disconnected'}" id="status-${id}">
                ${hasCookies ? 'âœ“ Connected' : 'Not connected'}
              </span>
            </div>
            ${lastSync ? `<div style="font-size:10px;color:#888;margin-bottom:8px;">Last sync: ${new Date(lastSync).toLocaleString()}</div>` : ''}
            
            <div style="display:flex;gap:8px;margin-bottom:10px;">
              <button class="toggle-btn" onclick="showInstagramLogin()" id="instagram-login-tab" style="font-weight:600;color:#667eea;">
                ğŸ” Login (Recommended)
              </button>
              <button class="toggle-btn" onclick="showInstagramCookies()" id="instagram-cookies-tab">
                ğŸª Cookies
              </button>
            </div>
            
            <!-- Browser Login (Recommended) -->
            <div class="platform-fields show" id="instagram-login-form">
              <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin-bottom:12px;">
                <div style="font-size:12px;color:#004085;margin-bottom:8px;">
                  <strong>ğŸŒ Browser Login (Best Method)</strong>
                </div>
                <div style="font-size:11px;color:#555;line-height:1.5;">
                  1. Click "Open Instagram Login" below<br>
                  2. Login to Instagram normally in the popup<br>
                  3. After login, cookies will be extracted automatically<br>
                  4. Handles 2FA & verification automatically!
                </div>
              </div>
              <div class="platform-actions">
                <button class="btn btn-primary btn-sm" onclick="loginInstagramBrowser()" id="instagram-login-btn" style="background:linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);">
                  ğŸ” Open Instagram Login
                </button>
                <button class="btn btn-secondary btn-sm" onclick="syncPlatform('instagram')">ğŸ”„ Sync</button>
                <button class="btn btn-danger btn-sm" onclick="clearPlatform('instagram')">ğŸ—‘ï¸</button>
              </div>
            </div>
            
            <!-- Cookies Form (Manual - hidden by default) -->
            <div class="platform-fields" id="instagram-cookies-form">
              <div style="background:#fff3cd;padding:8px;border-radius:6px;margin-bottom:10px;font-size:10px;color:#856404;">
                âš ï¸ Manual method - Use Browser Login above if possible
              </div>
              ${config.cookieFields.map(field => `
                <div class="form-group">
                  <label>${field}</label>
                  <input type="text" id="${id}-${field}" placeholder="${field}" value="${platformData.cookies?.[field] || ''}">
                  <small>${cookieInstructions[id]?.[field] || ''}</small>
                </div>
              `).join('')}
              <div class="platform-actions">
                <button class="btn btn-primary btn-sm" onclick="savePlatform('${id}')">ğŸ’¾ Save</button>
                <button class="btn btn-secondary btn-sm" onclick="syncPlatform('${id}')">ğŸ”„ Sync</button>
                <button class="btn btn-danger btn-sm" onclick="clearPlatform('${id}')">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        } else {
          card.innerHTML = `
            <div class="platform-header">
              <div class="platform-title">
                <span>${config.icon}</span>
                <span>${config.name}</span>
              </div>
              <span class="platform-status ${hasCookies ? 'connected' : 'disconnected'}" id="status-${id}">
                ${hasCookies ? 'âœ“ Connected' : 'Not connected'}
              </span>
            </div>
            ${lastSync ? `<div style="font-size:10px;color:#888;margin-bottom:8px;">Last sync: ${new Date(lastSync).toLocaleString()}</div>` : ''}
            <button class="toggle-btn" onclick="toggleFields('${id}')">
              ${hasCookies ? 'âœï¸ Edit cookies' : 'â• Add cookies'}
            </button>
            <div class="platform-fields" id="fields-${id}">
              ${config.cookieFields.map(field => `
                <div class="form-group">
                  <label>${field}</label>
                  <input type="text" id="${id}-${field}" placeholder="${field}" value="${platformData.cookies?.[field] || ''}">
                  <small>${cookieInstructions[id]?.[field] || ''}</small>
                </div>
              `).join('')}
              <div class="platform-actions">
                <button class="btn btn-primary btn-sm" onclick="savePlatform('${id}')">ğŸ’¾ Save</button>
                <button class="btn btn-secondary btn-sm" onclick="syncPlatform('${id}')">ğŸ”„ Sync</button>
                <button class="btn btn-danger btn-sm" onclick="clearPlatform('${id}')">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        }
        container.appendChild(card);
      }
    }
    
    // WhatsApp connect
    async function connectWhatsApp() {
      const btn = document.getElementById('whatsapp-connect-btn');
      const status = document.getElementById('status-whatsapp');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ Connecting...';
      }
      if (status) {
        status.className = 'platform-status syncing';
        status.textContent = 'â³ Connecting...';
      }
      
      try {
        whatsappState.status = 'connecting';
        renderPlatforms(); // Re-render to show loading state
        
        const result = await window.electronAPI.whatsappConnect();
        console.log('WhatsApp connect result:', result);
        
        // Update state
        whatsappState = { ...whatsappState, ...result };
        renderPlatforms();
        
      } catch (err) {
        console.error('WhatsApp connect error:', err);
        whatsappState.status = 'disconnected';
        renderPlatforms();
        alert('WhatsApp connect error: ' + err.message);
      }
    }
    
    // WhatsApp disconnect
    async function disconnectWhatsApp() {
      if (!confirm('Disconnect WhatsApp? You will need to scan QR code again.')) {
        return;
      }
      
      try {
        await window.electronAPI.whatsappDisconnect();
        whatsappState = {
          status: 'disconnected',
          qrCode: null,
          phoneNumber: null
        };
        credentials = await window.electronAPI.getCredentials();
        renderPlatforms();
      } catch (err) {
        console.error('WhatsApp disconnect error:', err);
        alert('Error disconnecting: ' + err.message);
      }
    }
    
    // Twitter tab switching
    function showTwitterLogin() {
      document.getElementById('twitter-login-form').classList.add('show');
      document.getElementById('twitter-cookies-form').classList.remove('show');
      document.getElementById('twitter-login-tab').style.fontWeight = '600';
      document.getElementById('twitter-login-tab').style.color = '#667eea';
      document.getElementById('twitter-cookies-tab').style.fontWeight = 'normal';
      document.getElementById('twitter-cookies-tab').style.color = '#888';
    }
    
    function showTwitterCookies() {
      document.getElementById('twitter-login-form').classList.remove('show');
      document.getElementById('twitter-cookies-form').classList.add('show');
      document.getElementById('twitter-login-tab').style.fontWeight = 'normal';
      document.getElementById('twitter-login-tab').style.color = '#888';
      document.getElementById('twitter-cookies-tab').style.fontWeight = '600';
      document.getElementById('twitter-cookies-tab').style.color = '#667eea';
    }
    
    // Instagram tab switching
    function showInstagramLogin() {
      document.getElementById('instagram-login-form').classList.add('show');
      document.getElementById('instagram-cookies-form').classList.remove('show');
      document.getElementById('instagram-login-tab').style.fontWeight = '600';
      document.getElementById('instagram-login-tab').style.color = '#667eea';
      document.getElementById('instagram-cookies-tab').style.fontWeight = 'normal';
      document.getElementById('instagram-cookies-tab').style.color = '#888';
    }
    
    function showInstagramCookies() {
      document.getElementById('instagram-login-form').classList.remove('show');
      document.getElementById('instagram-cookies-form').classList.add('show');
      document.getElementById('instagram-login-tab').style.fontWeight = 'normal';
      document.getElementById('instagram-login-tab').style.color = '#888';
      document.getElementById('instagram-cookies-tab').style.fontWeight = '600';
      document.getElementById('instagram-cookies-tab').style.color = '#667eea';
    }
    
    // Instagram browser login - opens Instagram in a popup window
    async function loginInstagramBrowser() {
      const btn = document.getElementById('instagram-login-btn');
      const status = document.getElementById('status-instagram');
      
      btn.disabled = true;
      btn.textContent = 'â³ Opening Instagram...';
      status.className = 'platform-status syncing';
      status.textContent = 'â³ Opening login...';
      
      try {
        const result = await window.electronAPI.loginInstagramBrowser();
        
        if (result.success) {
          status.className = 'platform-status connected';
          status.textContent = 'âœ“ Connected';
          alert('Instagram connected successfully! Syncing messages...');
          credentials = await window.electronAPI.getCredentials();
          renderPlatforms();
        } else {
          status.className = 'platform-status error';
          status.textContent = 'âœ— ' + (result.error || 'Login failed');
          if (result.error && result.error !== 'Login window was closed') {
            alert('Login failed: ' + result.error);
          }
        }
      } catch (err) {
        status.className = 'platform-status error';
        status.textContent = 'âœ— Error';
        alert('Login error: ' + err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'ğŸ” Open Instagram Login';
    }
    
    // Twitter login with username/password
    async function loginTwitter() {
      const username = document.getElementById('twitter-username').value.trim();
      const password = document.getElementById('twitter-password').value;
      const email = document.getElementById('twitter-email').value.trim();
      
      if (!username || !password) {
        alert('Please enter username and password');
        return;
      }
      
      const btn = document.getElementById('twitter-login-btn');
      const status = document.getElementById('status-twitter');
      btn.disabled = true;
      btn.textContent = 'â³ Logging in...';
      status.className = 'platform-status syncing';
      status.textContent = 'â³ Logging in...';
      
      try {
        const result = await window.electronAPI.loginTwitter({ username, password, email });
        if (result.success) {
          status.className = 'platform-status connected';
          status.textContent = 'âœ“ Connected';
          alert('Twitter connected! Now syncing messages...');
          credentials = await window.electronAPI.getCredentials();
          renderPlatforms();
          syncPlatform('twitter');
        } else {
          status.className = 'platform-status error';
          status.textContent = 'âœ— ' + (result.error || 'Login failed');
          alert('Login failed: ' + (result.error || 'Unknown error'));
        }
      } catch (err) {
        status.className = 'platform-status error';
        status.textContent = 'âœ— Error';
        alert('Login error: ' + err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'ğŸ” Login';
    }
    
    function toggleFields(platform) {
      const fields = document.getElementById(`fields-${platform}`);
      fields.classList.toggle('show');
    }
    
    async function savePlatform(platform) {
      const config = platforms[platform];
      const cookies = {};
      
      for (const field of config.cookieFields) {
        const value = document.getElementById(`${platform}-${field}`).value.trim();
        if (value) cookies[field] = value;
      }
      
      if (Object.keys(cookies).length !== config.cookieFields.length) {
        alert(`Please fill all cookie fields for ${config.name}`);
        return;
      }
      
      await window.electronAPI.saveCredentials({ platform, cookies });
      credentials = await window.electronAPI.getCredentials();
      renderPlatforms();
      
      // Auto sync after save
      syncPlatform(platform);
    }
    
    async function syncPlatform(platform) {
      const status = document.getElementById(`status-${platform}`);
      status.className = 'platform-status syncing';
      status.textContent = 'â³ Syncing...';
      
      await window.electronAPI.syncPlatform(platform);
    }
    
    async function clearPlatform(platform) {
      if (confirm(`Clear ${platforms[platform].name} credentials?`)) {
        await window.electronAPI.clearPlatform(platform);
        credentials = await window.electronAPI.getCredentials();
        renderPlatforms();
      }
    }
    
    // Global actions
    document.getElementById('save-token-btn').addEventListener('click', async () => {
      const token = document.getElementById('chatorbitor-token').value.trim();
      if (!token) {
        alert('Please enter your Chat Orbitor token');
        return;
      }
      await window.electronAPI.saveCredentials({ chatOrbitorToken: token });
      alert('Token saved!');
    });
    
    document.getElementById('sync-all-btn').addEventListener('click', async () => {
      document.getElementById('sync-all-btn').disabled = true;
      document.getElementById('sync-all-btn').textContent = 'â³ Syncing...';
      await window.electronAPI.syncAll();
      document.getElementById('sync-all-btn').disabled = false;
      document.getElementById('sync-all-btn').textContent = 'ğŸ”„ Sync All';
    });
    
    document.getElementById('clear-all-btn').addEventListener('click', async () => {
      if (confirm('Clear ALL credentials? This cannot be undone.')) {
        await window.electronAPI.clearAll();
        credentials = await window.electronAPI.getCredentials();
        document.getElementById('chatorbitor-token').value = '';
        renderPlatforms();
      }
    });
    
    // Listen for sync status updates
    window.electronAPI.onSyncStatus((data) => {
      const status = document.getElementById(`status-${data.platform}`);
      if (!status) return;
      
      if (data.syncing) {
        status.className = 'platform-status syncing';
        status.textContent = 'â³ Syncing...';
      } else if (data.success) {
        status.className = 'platform-status connected';
        status.textContent = 'âœ“ ' + data.message;
        // Just update credentials without re-rendering (to preserve input focus)
        setTimeout(async () => {
          credentials = await window.electronAPI.getCredentials();
          // Don't call renderPlatforms() here - it breaks input focus
        }, 1000);
      } else {
        status.className = 'platform-status error';
        status.textContent = 'âœ— ' + (data.message || 'Error');
      }
    });
    
    // Listen for Instagram login status updates
    window.electronAPI.onInstagramLoginStatus((data) => {
      const status = document.getElementById('status-instagram');
      const btn = document.getElementById('instagram-login-btn');
      
      if (!status) return;
      
      if (data.status === 'window_opened') {
        status.className = 'platform-status syncing';
        status.textContent = 'â³ Waiting for login...';
        if (btn) {
          btn.textContent = 'â³ Login in progress...';
        }
      } else if (data.status === 'success') {
        status.className = 'platform-status connected';
        status.textContent = 'âœ“ Connected';
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ğŸ” Open Instagram Login';
        }
        // Refresh credentials
        setTimeout(async () => {
          credentials = await window.electronAPI.getCredentials();
          renderPlatforms();
        }, 500);
      } else if (data.status === 'cancelled') {
        status.className = 'platform-status disconnected';
        status.textContent = 'Not connected';
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ğŸ” Open Instagram Login';
        }
      }
    });
    
    // Listen for WhatsApp status updates (QR code, connection, etc.)
    window.electronAPI.onWhatsAppStatus((data) => {
      console.log('WhatsApp status update:', data);
      
      // Update local state
      whatsappState.status = data.status || whatsappState.status;
      if (data.qrCode) {
        whatsappState.qrCode = data.qrCode;
      }
      if (data.phoneNumber) {
        whatsappState.phoneNumber = data.phoneNumber;
      }
      
      // Update status badge
      const status = document.getElementById('status-whatsapp');
      if (status) {
        if (data.status === 'connected') {
          status.className = 'platform-status connected';
          status.textContent = 'âœ“ Connected';
        } else if (data.status === 'qr_ready') {
          status.className = 'platform-status syncing';
          status.textContent = 'ğŸ“± Scan QR';
        } else if (data.status === 'connecting') {
          status.className = 'platform-status syncing';
          status.textContent = 'â³ Connecting...';
        } else if (data.status === 'error') {
          status.className = 'platform-status error';
          status.textContent = 'âœ— Error';
        } else {
          status.className = 'platform-status disconnected';
          status.textContent = 'Not connected';
        }
      }
      
      // Re-render to show QR code or updated state
      renderPlatforms();
      
      // Refresh credentials if connected
      if (data.status === 'connected') {
        setTimeout(async () => {
          credentials = await window.electronAPI.getCredentials();
          renderPlatforms();
        }, 1000);
      }
    });
    
    // Initialize
    async function init() {
      try {
        platforms = await window.electronAPI.getPlatforms();
        credentials = await window.electronAPI.getCredentials();
        document.getElementById('chatorbitor-token').value = credentials.chatOrbitorToken || '';
        
        // Check WhatsApp status
        try {
          const waStatus = await window.electronAPI.whatsappStatus();
          if (waStatus) {
            whatsappState = {
              status: waStatus.status || 'disconnected',
              qrCode: waStatus.qrCode || null,
              phoneNumber: waStatus.phoneNumber || null
            };
          }
        } catch (e) {
          console.log('WhatsApp status check failed:', e);
        }
        
        renderPlatforms();
      } catch (err) {
        console.error('Init error:', err);
      }
    }
    
    // Wait for DOM to be fully ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
